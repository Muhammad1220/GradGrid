<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Upload Your Plot Content</title>

  <!-- Cropper.js CSS -->
  <link
    href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css"
    rel="stylesheet"/>

  <style>
    :root {
      --navy:   #001f3f;
      --duck:   #00bfa5;
      --gray:   #e0e0e0;
      --white:  #ffffff;
      --light:  #fafafa;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: var(--gray);
      color: var(--navy);
      min-height: 100vh;
      display: flex; flex-direction: column;
    }
    .navbar {
      height: 60px; background: var(--navy);
      color: var(--white); display: flex;
      align-items: center; justify-content: space-between;
      padding: 0 1.5rem;
    }
    .navbar .brand {
      font-size: 1.25rem; font-weight: bold;
      color: var(--duck);
    }
    .navbar a {
      color: var(--white); text-decoration: none;
      margin-left: 1rem; font-weight: bold;
      cursor: pointer;
    }
    main {
      flex: 1; max-width: 600px;
      margin: 2rem auto; background: var(--white);
      padding: 2rem; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 { margin-bottom: 1rem; }
    #plot-info { margin-bottom: 1.5rem; font-weight: bold; }

    .already-uploaded {
      padding: 1rem;
      background: #ffeedd;
      border: 1px solid #ccaa99;
      border-radius: 4px;
      margin-bottom: 1rem;
      color: #663300;
      font-weight: bold;
      text-align: center;
    }

    form {
      display: flex; flex-direction: column;
      gap: 1rem;
    }
    .types { display: flex; gap: 1rem; font-weight: bold; }

    .links label {
      font-weight: bold;
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
    }
    .links input[type="url"] {
      margin-top: 0.25rem;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* Replace the old textarea with a contenteditable “text-editor” */
    .text-editor {
      width: 100%; 
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      height: 100px;            /* fixed height */
      resize: vertical;
      font-size: 1rem;          /* relative font-size */
      overflow-y: auto;         /* scroll if content overflows */
      background: #fff;         /* white background */
      color: var(--navy);       /* match body text color */
      caret-color: var(--duck); /* cursor color for editing */
    }
    button {
      padding: 0.75rem; background: var(--duck);
      color: var(--white); border: none;
      border-radius: 4px; font-size: 1rem;
      cursor: pointer;
    }
    .reset-btn {
      margin-top: 1rem;
    }

    .crop-container {
      width:100%; max-height:400px;
      margin-top:1rem; text-align:center;
    }
    .crop-container img {
      max-width:100%; display:inline-block;
    }
    .crop-controls {
      margin-top:0.5rem; display:flex;
      gap:0.5rem; justify-content:center;
    }
    .crop-controls button {
      padding:0.5rem 0.75rem; font-size:0.9rem;
      border:1px solid #ccc; border-radius:4px;
      background:#fff; cursor:pointer;
    }
    .crop-controls button img {
      width:20px; height:20px; display:block; margin:auto;
    }

    .text-controls {
      display: flex; gap: 0.5rem;
      justify-content: center; margin-top: 0.5rem;
      background: #000; padding: 0.5rem; border-radius: 4px;
    }
    .text-controls select,
    .text-controls button,
    .text-controls input[type="color"] {
      background: #000; color: #fff;
      border: 1px solid #555; border-radius: 4px;
      padding: 0.4rem 0.6rem; font-size: 0.9rem;
      cursor: pointer;
    }
    .text-controls button.active {
      background: var(--duck);
      border-color: var(--duck);
    }
    /* We no longer need a separate preview pane; inline editing shows formatting */
    /* (Delete the entire .text.preview block—no replacement needed.) */

    #final-preview {
      position: relative;
      width: 100vw; left: 50%;
      margin-left: -50vw; margin-top: 1rem;
      text-align: center;
    }
    #final-preview img,
    #final-preview .gif-crop-container {
      border: 1px solid #ddd; border-radius: 4px;
      max-width: 35vw; height: auto;
      display: inline-block; margin: 0 auto;
    }
    .gif-crop-container {
      overflow: hidden;
    }

    /* Show placeholder text when the contenteditable is empty */
    #text-editor:empty:before {
      content: attr(data-placeholder);
      color: #aaa;
      pointer-events: none;
    }


  </style>
</head>
<body>
  <!-- Toasts will appear here -->
  <div id="toast-container" style="position:fixed; top:1rem; right:1rem; z-index:1000;"></div>
  <a href="payment.html">Back to Payment</a>

  <nav class="navbar">
    <div class="brand">GradGrid 2025</div>
    <div>
      <a href="index.html">Home</a>
      <a href="payment.html">Back to Payment</a>
    </div>
  </nav>

  <main>
    <h2>Upload Your Plot Content</h2>
    <div id="plot-info"></div>

    <form id="upload-form">
      <div class="types">
        <label><input type="radio" name="type" value="image" checked> Image</label>
        <label><input type="radio" name="type" value="text"> Text</label>
      </div>

      <div class="links">
        <label>
          Optional link (where clicking your plot should go):
          <input type="url" id="link-input"
                 placeholder="https://www.instagram.com"
                 pattern="https?://.+"
                 title="Include http:// or https://">
        </label>
      </div>

      <div id="image-group">
        <label>
          Choose PNG/GIF/JPG (max 3 MB):
          <input type="file" id="image-input"
                 accept="image/png,image/gif,image/jpeg">
        </label>
      </div>

      <div id="text-group" style="display:none;">
        <label>
          Enter text (max 300 chars):
          <div id="text-editor"
               class="text-editor"
               contenteditable="true"
               data-placeholder="insert message"></div>
        </label>
        <div class="text-controls" id="text-controls" style="display:none;">
          <select id="font-select">
            <option>Arial</option><option>Helvetica</option>
            <option>Times New Roman</option><option>Georgia</option>
            <option>Verdana</option><option>Tahoma</option>
            <option>Trebuchet MS</option><option>Courier New</option>
            <option>Lucida Console</option><option>Impact</option>
          </select>
          <input type="color" id="text-color-picker"
                 value="#ffffff" title="Text Color">
          <input type="color" id="highlight-color-picker"
                 value="#000000" title="Highlight Color">
          <button type="button" id="bold-btn"><b>B</b></button>
          <button type="button" id="italic-btn"><i>I</i></button>
          <button type="button" id="underline-btn"><u>U</u></button>
          <button type="button" id="text-zoom-in">+</button>
          <button type="button" id="text-zoom-out">–</button>
        </div>
      </div>

      <button type="submit">Submit</button>
    </form>

    <div class="preview" id="preview">
      <div class="crop-container" id="crop-container" style="display:none;">
        <img id="crop-target" alt="Crop target">
      </div>
      <div class="crop-controls" id="crop-controls" style="display:none;">
        <button type="button" id="zoom-in"><img src="zoom-in.png" alt="⊕"></button>
        <button type="button" id="zoom-out"><img src="zoom-out.png" alt="⊖"></button>
        <button type="button" id="rotate-left"><img src="rotate-left.png" alt="↺"></button>
        <button type="button" id="rotate-right"><img src="rotate-right.png" alt="↻"></button>
        <button type="button" id="reset"><img src="reset.png" alt="⟳"></button>
      </div>
      <div id="final-preview" style="display:none;">
        <h3>Final Plot Preview:</h3>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
  <!-- 1. Load Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <!-- 2. Init Supabase client -->
  <script>
    const SUPABASE_URL      = 'https://ljvfdbrxelmqyufxifsg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqdmZkYnJ4ZWxtcXl1ZnhpZnNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1NDYwMTcsImV4cCI6MjA2NDEyMjAxN30.vXd5WBBpJgsPeTQRZRcWOzbKJ0uQULyrCPiMlfyKr6A';
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
  <script>
    // helper to show non-blocking in-page toasts
    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.style.marginBottom   = '10px';
      toast.style.padding         = '12px';
      toast.style.borderRadius    = '4px';
      toast.style.boxShadow       = '0 2px 6px rgba(0,0,0,0.2)';
      toast.style.backgroundColor = type === 'error' ? '#f44336' : '#4CAF50';
      toast.style.color           = 'white';
      toast.textContent           = message;
  
      const container = document.getElementById('toast-container');
      container.appendChild(toast);
  
      setTimeout(() => {
        container.removeChild(toast);
      }, 3000);
    }
  
    document.addEventListener('DOMContentLoaded', () => {
      const reservation = JSON.parse(localStorage.getItem('gradgrid-reservation')||'{}');
      const infoEl      = document.getElementById('plot-info');
      const uploadForm  = document.getElementById('upload-form');
      const imageGroup  = document.getElementById('image-group');
      const textGroup   = document.getElementById('text-group');
      const cropContainer = document.getElementById('crop-container');
      const cropControls  = document.getElementById('crop-controls');
      const finalPreview  = document.getElementById('final-preview');
      const imageInput    = document.getElementById('image-input');
      const textEditor    = document.getElementById('text-editor');
      const textControls  = document.getElementById('text-controls');
      const fontSelect    = document.getElementById('font-select');
      const colorPicker   = document.getElementById('text-color-picker');
      const highlightPicker = document.getElementById('highlight-color-picker');
      const boldBtn       = document.getElementById('bold-btn');
      const italicBtn     = document.getElementById('italic-btn');
      const underlineBtn  = document.getElementById('underline-btn');
      const zoomInTxt     = document.getElementById('text-zoom-in');
      const zoomOutTxt    = document.getElementById('text-zoom-out');
      let cropper         = null;
      let originalType    = '';
      /* We will use document.execCommand() on the contenteditable div.
         Keep tFont, tSize, tBold, etc., for the canvas-generation step. */
      let tFont   = 'Arial',
          tSize   = 16,       // start with 16px; user can zoom in/out
          tBold   = false,
          tItalic = false,
          tUnder  = false,
          tColor  = '#ffffff',
          tHighlight = '#000000';

      // Reservation check
      if (reservation.minR == null) {
        infoEl.innerHTML = '<p style="color:red">No reservation found. Please start over.</p>';
        uploadForm.style.display = 'none';
        document.getElementById('preview').style.display = 'none';
        return;
      }
      const w = reservation.maxC - reservation.minC + 1;
      const h = reservation.maxR - reservation.minR + 1;
      window.plotRatio = w / h;
      const row = n => String.fromCharCode(65 + n);
      const rows = reservation.minR === reservation.maxR
        ? row(reservation.minR)
        : `${row(reservation.minR)}–${row(reservation.maxR)}`;
      const cols = reservation.minC === reservation.maxC
        ? reservation.minC + 1
        : `${reservation.minC + 1}–${reservation.maxC + 1}`;
      infoEl.textContent = `Plot: Rows ${rows}, Cols ${cols}`;

      // Already uploaded?
      const uploads = JSON.parse(localStorage.getItem('gradgrid-uploads')||'[]');
      const already = uploads.some(u =>
        u.minR === reservation.minR &&
        u.maxR === reservation.maxR &&
        u.minC === reservation.minC &&
        u.maxC === reservation.maxC
      );
      if (already) {
        infoEl.insertAdjacentHTML('afterend',
          '<div class="already-uploaded">You’ve already uploaded content for this plot.</div>'
        );
        const banner = document.querySelector('.already-uploaded');
        banner.insertAdjacentHTML('afterend',
          '<button id="reset-upload" type="button" aria-label="Change plot content" class="reset-btn">Change Content</button>'
        );
        uploadForm.style.display  = 'none';
        document.getElementById('preview').style.display = 'none';

        const resetBtn = document.getElementById('reset-upload');
        resetBtn.addEventListener('click', () => {
          if (!confirm('Are you sure you want to replace your upload?')) return;

          // Remove stored entry
          const arr = JSON.parse(localStorage.getItem('gradgrid-uploads')||'[]');
          const filtered = arr.filter(u =>
            !(u.minR===reservation.minR &&
              u.maxR===reservation.maxR &&
              u.minC===reservation.minC &&
              u.maxC===reservation.maxC)
          );
          localStorage.setItem('gradgrid-uploads', JSON.stringify(filtered));

          // Tear down cropper
          if (cropper) { cropper.destroy(); cropper = null; }
          originalType = '';

          // Clear & hide final preview
          finalPreview.querySelectorAll('img, .gif-crop-container').forEach(el=>el.remove());
          finalPreview.style.display = 'none';

          // Reset text mode
          textEditor.innerText = '';
          textControls.style.display = 'none';
          // (no textPreview to hide)
          tFont = 'Arial'; tSize = 16; tBold = false; tItalic = false; tUnder = false;
          tColor = '#ffffff'; tHighlight = '#000000';
          boldBtn.classList.remove('active');
          italicBtn.classList.remove('active');
          underlineBtn.classList.remove('active');

          // Restore default mode
          document.querySelector('input[name="type"][value="image"]').checked = true;
          imageGroup.style.display      = 'block';
          textGroup.style.display       = 'none';
          cropContainer.style.display   = 'none';
          cropControls.style.display    = 'none';

          // Clear inputs
          document.getElementById('image-input').value = '';
          const linkInput = document.getElementById('link-input');
          if (linkInput) linkInput.value = '';

          // Remove banner & button
          banner.remove();
          resetBtn.remove();

          // Focus first field
          document.getElementById('image-input').focus();
        });

        return;
      }

      // Type toggle
      document.querySelectorAll('input[name="type"]').forEach(radio=>{
        radio.addEventListener('change', ()=>{
          const isImg = radio.value==='image';
          imageGroup.style.display      = isImg?'block':'none';
          textGroup.style.display       = isImg?'none':'block';
          cropContainer.style.display   = 'none';
          cropControls.style.display    = 'none';
          textControls.style.display    = 'none';
          textEditor.innerText = '';          // clear contenteditable when switching away
          finalPreview.style.display    = 'none';
        });
      });

      // Image upload
      imageInput.addEventListener('change', ()=>{
        const file = imageInput.files[0];
        if (!file) return;
        if (file.size > 3*1024*1024) return showToast('File exceeds 3 MB', 'error');
        originalType = file.type;
        const reader = new FileReader();
        reader.onload = ()=>{
          finalPreview.querySelectorAll(':scope>:not(h3)').forEach(el=>el.remove());
          finalPreview.style.display='block';
          const img = document.getElementById('crop-target');
          img.src = reader.result;
          cropContainer.style.display = 'block';
          cropControls.style.display = 'flex';
          if (cropper) cropper.destroy();
          cropper = new Cropper(img, {
            aspectRatio: originalType==='image/gif'?NaN:window.plotRatio,
            viewMode: 1,
            autoCropArea: 1,
            dragMode: 'none',
            rotatable: originalType!=='image/gif',
            background: false,
            ready() { updateImgPreview() },
            crop()  { updateImgPreview() }
          });
        };
        reader.onerror = ()=>{
          alert('Oops—couldn’t read that file. Try a different image.');
        };
        reader.readAsDataURL(file);
      });


      function updateImgPreview(){
        finalPreview.querySelectorAll(':scope>:not(h3)').forEach(el=>el.remove());
        const H=200,W=Math.round(H*window.plotRatio);
        if(originalType==='image/gif'){
          const box=cropper.getCropBoxData(),imgD=cropper.getImageData(),
                sx=W/box.width,sy=H/box.height;
          const container=document.createElement('div');
          container.className='gif-crop-container';
          container.style.width=W+'px';
          container.style.height=H+'px';
          const anim=document.createElement('img');
          anim.src=document.getElementById('crop-target').src;
          anim.style.width=imgD.naturalWidth*sx+'px';
          anim.style.height=imgD.naturalHeight*sy+'px';
          anim.style.transform=`translate(${-box.left*sx}px,${-box.top*sy}px)`;
          anim.style.transformOrigin='top left';
          container.appendChild(anim);
          finalPreview.appendChild(container);
          return;
        }
        const canvasEl=cropper.getCroppedCanvas({width:W,height:H}),
              img2=document.createElement('img');
        img2.src=canvasEl.toDataURL();
        finalPreview.appendChild(img2);
      }

      ['zoom-in','zoom-out','rotate-left','rotate-right','reset'].forEach(id=>{
        document.getElementById(id).onclick=()=>{
          if(!cropper) return;
          const ops={'zoom-in':()=>cropper.zoom(.1),
                     'zoom-out':()=>cropper.zoom(-.1),
                     'rotate-left':()=>cropper.rotate(-45),
                     'rotate-right':()=>cropper.rotate(45),
                     'reset':()=>cropper.reset()};
          ops[id]();
        };
      });

      // When user types in the contenteditable:
      textEditor.addEventListener('input', () => {
        // 1) Enforce max 300 chars:
        if (textEditor.innerText.length > 300) {
          textEditor.innerText = textEditor.innerText.slice(0, 300);
          // Move caret to end:
          const range = document.createRange();
          range.selectNodeContents(textEditor);
          range.collapse(false);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        }

        // 2) Show formatting controls and preview now that there's text:
        textControls.style.display = 'flex';
        finalPreview.style.display = 'block';
      });

      // Formatting buttons now use execCommand on the contenteditable:
      fontSelect.onchange = () => {
        document.execCommand('fontName', false, fontSelect.value);
      };
      colorPicker.oninput = () => {
        document.execCommand('foreColor', false, colorPicker.value);
      };
      highlightPicker.oninput = () => {
        document.execCommand('hiliteColor', false, highlightPicker.value);
      };
      boldBtn.onclick = () => {
        document.execCommand('bold', false, null);
        boldBtn.classList.toggle('active');
      };
      italicBtn.onclick = () => {
        document.execCommand('italic', false, null);
        italicBtn.classList.toggle('active');
      };
      underlineBtn.onclick = () => {
        document.execCommand('underline', false, null);
        underlineBtn.classList.toggle('active');
      };
      zoomInTxt.onclick = () => {
        tSize = Math.min(64, tSize * 1.1); // cap at 64px
        document.execCommand('fontSize', false, 7); 
        /* Workaround: execCommand('fontSize',7) sets font-size to largest preset. 
           Then we override <font size="7"> to our computed px. */
        const fonts = textEditor.getElementsByTagName('font');
        Array.from(fonts).forEach(f => {
          f.removeAttribute('size');
          f.style.fontSize = tSize + 'px';
        });
      };
      zoomOutTxt.onclick = () => {
        tSize = Math.max(12, tSize * 0.9); // floor at 12px
        document.execCommand('fontSize', false, 7);
        const fonts = textEditor.getElementsByTagName('font');
        Array.from(fonts).forEach(f => {
          f.removeAttribute('size');
          f.style.fontSize = tSize + 'px';
        });
      };

      // Submit → upload to Supabase Storage + insert into uploads table
      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const type = document.querySelector('input[name="type"]:checked').value;
        const link = document.getElementById('link-input').value.trim();
        if (link && !/^https?:\/\//.test(link)) {
          return alert('Please include http:// or https://');
        }

        // 1. Prepare Blob + extension + optional text content
        let blob, extension, textContent = null;
        if (type === 'image') {
          if (originalType === 'image/gif') {
            // GIF: grab the cropped <img> src and fetch as blob
            const gifImg = finalPreview.querySelector('.gif-crop-container img');
            if (!gifImg) return alert('Something went wrong with your GIF.');
            blob = await fetch(gifImg.src).then(res => res.blob());
            extension = 'gif';
          } else {
            if (!cropper) return alert('Please select & adjust an image.');
            blob = await new Promise(resolve => cropper.getCroppedCanvas().toBlob(resolve));
            extension = originalType.split('/')[1]; // e.g. "png" or "jpeg"
          }
        } else {
          // Text: draw your preview canvas to a blob
          // Retrieve plain text from the contenteditable, preserving line breaks:
          const txt = textEditor.innerText.trim();
          if (!txt) return alert('Please enter and format your text.');
          textContent = txt;

          // Render the text (with styling) onto a hidden <canvas>:
          const canvas = document.createElement('canvas');
          const H = 200, W = Math.round(H * window.plotRatio);
          canvas.width = W; 
          canvas.height = H;
          const ctx = canvas.getContext('2d');
          // Fill background with highlight color:
          ctx.fillStyle = tHighlight; ctx.fillRect(0, 0, W, H);

          // We will parse each line and draw it using the current tSize, tFont, tColor, tBold, etc.
          const lines = txt.split('\n');
          ctx.fillStyle = tColor;
          ctx.font = `${tItalic?'italic ':''}${tBold?'bold ':''}${tSize}px ${tFont}`;
          ctx.textAlign = 'center'; 
          ctx.textBaseline = 'middle';

          const lh = tSize * 1.2;
          const startY = (H - lines.length * lh) / 2 + lh / 2;
          lines.forEach((l, i) => {
            const y = startY + i * lh;
            ctx.fillText(l, W / 2, y);
            if (tUnder) {
              const m = ctx.measureText(l).width;
              const uy = y + tSize / 2;
              ctx.beginPath();
              ctx.moveTo(W/2 - m/2, uy);
              ctx.lineTo(W/2 + m/2, uy);
              ctx.lineWidth = 2; ctx.strokeStyle = tColor; ctx.stroke();
            }
          });

          blob = await new Promise(resolve => canvas.toBlob(resolve));
          extension = 'png';
        }


        // 2. Upload blob to Supabase Storage
        const fileName = `upload-${Date.now()}.${extension}`;
        const { data: storageData, error: upErr } = await supabase
          .storage
          .from('uploads')
          .upload(
            `public/${fileName}`,
            blob,
            {
              cacheControl: '3600',
              upsert:      false,
              contentType: blob.type
            }
          );
        if (upErr) {
          alert('Storage upload error: ' + upErr.message);
          return;
        }

        // 3. Get the public URL
        const filePath = storageData.path;
        const { data: { publicUrl }, error: urlErr } = supabase
          .storage
          .from('uploads')
          .getPublicUrl(filePath);
        if (urlErr) {
          alert('URL fetch error: ' + urlErr.message);
          return;
        }

        // 4. Insert a row into your uploads table
        const { error: dbErr } = await supabase
          .from('uploads')
          .insert([{
            url:      publicUrl,
            type:     type,
            content:  textContent,
            min_r:    reservation.minR,
            max_r:    reservation.maxR,
            min_c:    reservation.minC,
            max_c:    reservation.maxC,
            link:     link || null
          }]);
        if (dbErr) return alert('Database insert error: ' + dbErr.message);



        // 5. Success!
        alert('Upload successful! Redirecting…');
        window.location.href = 'final.html';
      });

    });
  </script>

  <!-- RELEASE-ON-LEAVE LOGIC -->
  <script>
    // track if the form was successfully submitted
    let uploadConfirmed = false;
    const form = document.getElementById('upload-form');
    form.addEventListener('submit', () => {
      uploadConfirmed = true;
    });

    // before unloading, if not confirmed, release the reserved plots
    window.addEventListener('beforeunload', () => {
      if (!uploadConfirmed) {
        const reservation = JSON.parse(localStorage.getItem('gradgrid-reservation') || '{}');
        if (reservation.minR != null) {
          const stillReserved = JSON.parse(localStorage.getItem('gradgrid-reserved') || '[]')
            .filter(cell =>
              cell.r < reservation.minR ||
              cell.r > reservation.maxR ||
              cell.c < reservation.minC ||
              cell.c > reservation.maxC
            );
          localStorage.setItem('gradgrid-reserved', JSON.stringify(stillReserved));
          localStorage.removeItem('gradgrid-reservation');
          localStorage.removeItem('gradgrid-requiredCount');
        }
      }
    });
  </script>
</body>
</html>
