<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Confirm Your Reservation</title>
  <style>
    :root {
      --navy: #001f3f;
      --duck: #00bfa5;
      --white: #ffffff;
      --light: #fafafa;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--light);
      color: var(--navy);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .navbar {
      height: 60px;
      background: var(--navy);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
    }

    .navbar .brand {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--duck);
    }

    .navbar a {
      color: var(--white);
      text-decoration: none;
      margin-left: 1rem;
      font-weight: bold;
      cursor: pointer;
    }

    main {
      flex: 1;
      max-width: 400px;
      margin: 2rem auto;
      background: var(--white);
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    h2 {
      margin-top: 0;
      margin-bottom: 1rem;
    }

    .summary p {
      margin: 0.5rem 0;
      font-size: 1rem;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
      font-size: 0.95rem;
    }

    input {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      margin-top: 0.25rem;
    }

    button {
      padding: 0.75rem;
      background: var(--duck);
      color: var(--white);
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <nav class="navbar">
    <div class="brand">GradGrid 2025</div>
    <div class="menu">
      <a href="index.html">Cancel</a>
      <a href="upload.html">Back to Upload</a>
      <a href="gallery.html">Gallery of Uploads</a>
      <a href="faq.html">Help / FAQ</a>
    </div>
  </nav>

  <main>
    <div class="summary">
      <h2>Confirm Your Reservation</h2>
      <p>
        <strong>Plots:</strong>
        <span id="count-display">0</span>
      </p>
      <p>
        <strong>Total:</strong>
        $<span id="total-display">0.00</span>
      </p>
      <!-- (Removed original 20:00 timer; replaced by the Stripe Checkout + 10-minute timer below) -->
    </div>

    <!-- NEW BLOCK: Stripe Checkout button + 10-minute timer (replaces old <form>) -->
    <p>
      <strong>Time Remaining:</strong>
      <span id="timer-display">10:00</span>
    </p>
    <button id="checkout-btn">Pay Now</button>

    <!-- Load Supabase first so `supabase` is defined -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <!-- Then load Stripe.js, then run the Stripe + timer logic -->
    <script src="https://js.stripe.com/v3"></script>
    <script>
      (async () => {
        // 1) Initialize Supabase client for reads
        const supabaseClient = supabase.createClient(
          'https://ljvfdbrxelmqyufxifsg.supabase.co',
          null
        );

        // 2) Initialize Stripe with your publishable key
        const stripe = Stripe("pk_test_51RMzWm2euuVHjVwe4sOT0znfaDHUwRBzcvF0xBNpvT68PlollRNLOW6cTMN5EGiC8O89Ko4q0kA2l9JSDQdIV53900N3AxXjNH");

        // 3) Extract uploadId from URL
        const urlParams = new URLSearchParams(window.location.search);
        const uploadId = urlParams.get('uploadId');
        if (!uploadId) {
          alert('Missing uploadId. Please retry.');
          window.location.href = 'index.html';
          return;
        }

        // 4) Fetch reservation’s reserved_at timestamp
        const { data: resRow } = await supabaseClient
          .from('reservations')
          .select('reserved_at')
          .eq('upload_id', uploadId)
          .single();

        if (!resRow) {
          alert('No reservation found. Please re-select your plot.');
          window.location.href = 'index.html';
          return;
        }

        // 5) Compute the 10-minute payment cutoff
        const reservedAt = new Date(resRow.reserved_at);
        const paymentExpires = new Date(reservedAt.getTime() + 10 * 60 * 1000);

        // 6) Start countdown timer (updates ONLY #timer-display)
        const timerDisplay = document.getElementById('timer-display');
        const timerInterval = setInterval(() => {
          const now = new Date();
          const diff = paymentExpires - now;

          if (diff <= 0) {
            clearInterval(timerInterval);
            // Expire the hold in Supabase:
            supabaseClient
              .from('reservations')
              .delete()
              .eq('upload_id', uploadId);
            alert('Your 10-minute window has expired. Please re-select your plot.');
            window.location.href = 'index.html';
            return;
          }

          // Update “mm:ss”
          const minutes = Math.floor(diff / 60000);
          const seconds = Math.floor((diff % 60000) / 1000);
          timerDisplay.textContent =
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);

        // 7) “Pay Now” click handler
        document.getElementById('checkout-btn').addEventListener('click', async () => {
          document.getElementById('checkout-btn').disabled = true;

          // 7a) Recalculate dynamic price
          const { data: soldRows } = await supabaseClient
            .from('uploads')
            .select('min_r, max_r, min_c, max_c')
            .eq('paid', true);

          let soldCells = 0;
          soldRows.forEach(r => {
            soldCells += (r.max_r - r.min_r + 1) * (r.max_c - r.min_c + 1);
          });
          const blocksSold = Math.floor(soldCells / 10);
          const surcharge = blocksSold * 0.5;
          const basePrice = 2.00; // $2.00/plot
          const currentPrice = basePrice + surcharge;
          const amountInCents = Math.round(currentPrice * 100);

          // 7b) Get plot dimensions for quantity
          const { data: uploadRow } = await supabaseClient
            .from('uploads')
            .select('min_r, max_r, min_c, max_c')
            .eq('id', uploadId)
            .single();

          const width = uploadRow.max_c - uploadRow.min_c + 1;
          const height = uploadRow.max_r - uploadRow.min_r + 1;
          const quantity = width * height;

          // 7c) Call Netlify Function to create a Checkout Session
          const response = await fetch('/.netlify/functions/create-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              uploadId,
              unitAmount: amountInCents,
              quantity
            }),
          });

          const { sessionId } = await response.json();
          // 7d) Redirect to Stripe Checkout
          await stripe.redirectToCheckout({ sessionId });
        });

        // 8) If user returns with ?canceled=true, expire hold immediately
        if (urlParams.get('canceled') === 'true') {
          await supabaseClient
            .from('reservations')
            .delete()
            .eq('upload_id', uploadId);
          window.location.href = 'index.html?paymentCanceled=true';
        }
      })();
    </script>
  </main>

  <!-- (Removed obsolete Supabase import; it is now loaded above in the Stripe/timer block) -->
</body>

</html>