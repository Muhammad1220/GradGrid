  <!-- 1) Load Supabase JS library (v2 UMD build) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <!-- 2) Initialize Supabase client and wire up Confirm Payment button -->
  <script>
    // (Replace these values with your actual project URL and anon key)
    const SUPABASE_URL      = 'https://ljvfdbrxelmqyufxifsg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqdmZkYnJ4ZWxtcXl1ZnhpZnNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1NDYwMTcsImV4cCI6MjA2NDEyMjAxN30.vXd5WBBpJgsPeTQRZRcWOzbKJ0uQULyrCPiMlfyKr6A';
    try {
      window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Final.html: Supabase initialized.');
    } catch (err) {
      console.error('Final.html: Failed to initialize Supabase:', err);
    }

    // Retrieve reservation details (only need these for display)
    const res = JSON.parse(localStorage.getItem('gradgrid-reservation') || '{}');

    // Helper to convert row index to letter
    function toLetter(n) {
      return String.fromCharCode(65 + n);
    }

    // Build human-readable plot range
    const rowLabel = res.minR === res.maxR
      ? toLetter(res.minR)
      : `${toLetter(res.minR)}–${toLetter(res.maxR)}`;
    const colLabel = res.minC === res.maxC
      ? (res.minC + 1)
      : `${res.minC + 1}–${res.maxC + 1}`;

    // Populate summary (dummy card info)
    document.getElementById('summary').innerHTML = `
      <p><strong>Plots:</strong> Rows ${rowLabel}, Cols ${colLabel}</p>
      <p><strong>Area:</strong> ${res.area || 0} plot(s)</p>
      <p><strong>Charged to Card:</strong> •••• •••• •••• 1234</p>
    `;

    // Confirm Payment button: mark paid=true in Supabase, then go to index.html
    document.getElementById('done-btn').addEventListener('click', async () => {
      console.log('Confirm Payment clicked');

      // 3a) Parse uploadId from URL
      const params   = new URLSearchParams(window.location.search);
      const uploadId = params.get('uploadId');
      console.log('Parsed uploadId =', uploadId);
      if (!uploadId) {
        alert('Missing uploadId. Please retry.');
        return;
      }

      // 3b) Update Supabase row: set paid = true
      try {
        console.log('Calling Supabase to update paid flag…');
        const { data, error: dbErr } = await supabase
          .from('uploads')
          .update({ paid: true })
          .eq('id', uploadId);

        if (dbErr) {
          console.error('Supabase.update returned error:', dbErr);
          alert('Could not confirm payment; please try again.');
          return;
        }
        console.log('Supabase.update succeeded:', data);
      } catch (updateError) {
        console.error('Exception when calling Supabase.update:', updateError);
        alert('Could not confirm payment; please try again.');
        return;
      }

      // 3c) Clear reservation data and redirect back to homepage
      localStorage.removeItem('gradgrid-requiredCount');
      localStorage.removeItem('gradgrid-reservation');
      console.log('Redirecting to index.html');
      window.location.href = 'index.html';
    });
  </script>
